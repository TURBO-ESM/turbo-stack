module test_broadcast_real2D
  use pfunit
  use MOM_coms_infra
  use MOM_test_case
  use iso_fortran_env, only : int32, real64
  implicit none

  @testCase()
  type, extends(MOM_MPI_test_case) :: testcase_broadcast
  end type testcase_broadcast

contains

  @test(npes=[4])
  subroutine test_bcast_real2D(this)
    class (testcase_broadcast), intent(inout) :: this

    real(kind=real64),allocatable :: value(:,:)

    integer(kind=int32), parameter :: len1 = 20, len2 = 7
    real(kind=real64) :: rank, actual, expected

    rank = dble(this%getProcessRank())

    allocate(value(len1,len2))

    value = rank
    !--------------------------------------
    ! Broadcast from the default root rank
    !--------------------------------------
    call broadcast(value,len1*len2)

    actual = count(value .ne. 0.0)
    expected = 0
    @assertEqual(expected, actual)

    value = rank
    !--------------------------------------
    ! Broadcast from the non-default rank
    !--------------------------------------
    call broadcast(value,len1*len2, from_PE=1)

    actual = count(value .ne. 1.0)
    expected = 0
    @assertEqual(expected, actual)

    deallocate(value)

  end subroutine test_bcast_real2D


end module test_broadcast_real2D
