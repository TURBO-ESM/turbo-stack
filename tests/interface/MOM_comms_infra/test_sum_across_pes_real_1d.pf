module test_sum_across_pes_real_1d
  use pfunit
  use MOM_coms_infra, only : sum_across_PEs
  use MOM_test_case
  use iso_fortran_env, only : int32, real64
  implicit none

  @testCase()
  type, extends(MOM_MPI_test_case) :: test_case_sum_across_pes
  end type test_case_sum_across_pes

contains

  @test(npes=[4])
  subroutine test_SumAcrossPEs(this)
    class (test_case_sum_across_pes), intent(inout) :: this
    integer(kind=int32) :: comm_size, comm_rank
    integer(kind=int32) :: i
    real(kind=real64), dimension(:), allocatable :: expected_global_sum
    real(kind=real64), dimension(:), allocatable :: actual_global_sum
    real(kind=real64), parameter :: tolerance = 1.0e-12_real64

    comm_size = this%getNumProcesses()
    comm_rank = this%getProcessRank()

    allocate(expected_global_sum(comm_size))
    expected_global_sum = sum([(i, i=0,comm_size-1)])

    allocate(actual_global_sum(comm_size))
    actual_global_sum = real(comm_rank, kind=real64)
    call sum_across_PEs(actual_global_sum, size(actual_global_sum))

    @assertEqual(expected_global_sum, actual_global_sum, tolerance=tolerance)

    deallocate(expected_global_sum)
    deallocate(actual_global_sum)

  end subroutine test_SumAcrossPEs
   
end module test_sum_across_pes_real_1d
